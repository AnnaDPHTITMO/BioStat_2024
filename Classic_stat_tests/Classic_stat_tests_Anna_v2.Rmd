---
title: "Классические_статистические_тесты_v2.ДЗ"
author: "Anna Andreychenko"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = T)
library(dplyr)

```



# Гипотеза 1.
**Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
#activity100 <- rbinom(sample_size, 1, 0.5)
activity100 <- c(rep(1, sample_size/2), rep(0, sample_size/2))

# Коммент 1. Общий размер выборки должен быть 100 (у Вас 200) - СКОРРЕКТИРОВАНО

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

#cardio100 <- c(rbinom(sample_size/2, 1, 0.5), rbinom(sample_size/2, 1, 0.6))
#cardio100 <- rbinom(sample_size, 1, ifelse(activity100 == 1, 0.5, 0.6))
cardio100 <- c(rep(1, 0.5*sample_size/2), rep(0, 0.5*sample_size/2), rep(0, 0.4*sample_size/2), rep(1, 0.6*sample_size/2))

# Коммент 2. У активных людей меньше вероятность заболеть (0.5 vs 0.6) (у Вас 0.55 на 0.55) - ИСПРАВЛЕНО НА ГЕНЕРАЦИЮ ВЫБОРКИ "В лоб"

table(activity100, cardio100)

#fisher.test(activity100, cardio100)

```

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity30 <- c(rep(1, sample_size/2), rep(0, sample_size/2)) 

# Коммент 3. Общий размер выборки должен быть 30 (у Вас 60) - СКОРРЕКТИРОВАНО

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

#cardio30 <- rbinom(sample_size, 1, ifelse(activity30 == 1, 0.5, 0.6)) 

# Коммент 4. У активных людей меньше вероятность заболеть (0.5 vs 0.6) (у Вас люди с низкой активностью болеют реже)- ОТВЕТ исправила на прямое задание кол-ва успехов

cardio30 <- c(rep(1, 7), rep(0, 8), rep(0, 0.4*sample_size/2), rep(1, 0.6*sample_size/2))

table(activity30, cardio30)

#fisher.test(activity30, cardio30)
    
```

## Решение


```{r, fig.height =5, fig.width=5}

# Функция для проведения z-теста для двух независимых долей
performTwoProportionZTest <- function(t) {
  
  x <- t[1,2]
  n1<- t[1,2]+t[1,1]
  
    y <- t[2,2]
  n2<- t[2,2]+t[2,1]
  
  # Расчет долей успешных исходов в выборках
  p1 <- x / n1
  p2 <- y / n2

  # Расчет объединенной доли успешных исходов
  P <- (x + y) / (n1 + n2)

  # Расчет стандартной ошибки
  SQ <- P * (1 - P) * (1/n1 + 1/n2)

  # Выполнение z-теста
  z_test_result <- (p1 - p2) / sqrt(SQ)

  return(z_test_result)
}

z_test_result100 <- performTwoProportionZTest(table(activity100,cardio100))
#print(z_test_result100)

z_test_result30 <- performTwoProportionZTest(table(activity30,cardio30))
#print(z_test_result30)


# Загрузка необходимого пакета ggplot2
library(ggplot2)


# Создание последовательности значений x
x_values <- seq(-4, 4, by = 0.01)

# Расчет значений Плотности Вероятности (PDF) для стандартного нормального распределения
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)

# Квантили
quantiles <- c(0.025, 0.975)

quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

# Создание данных для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = quantile_values, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = z_test_result100, linewidth = 2, linetype = "dashed", color = "red") +
    geom_vline(xintercept = z_test_result30, linewidth = 2, linetype = "dashed", color = "darkgreen") +
  annotate("text", x = quantile_values[1]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], quantile_values[1]), hjust = 0, angle = 90) +
  annotate("text", x = quantile_values[2]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], quantile_values[2]), hjust = 0, angle = 90) +
  annotate("text", x = z_test_result100-0.15, y = 0.2, label = 'observed, 100', hjust = 0, angle = 90)+
  annotate("text", x = z_test_result30-0.15, y = 0.2, label = 'observed, 30', hjust = 0, angle = 90)+  
  labs(title = "PDF стандартного нормального распределения", x = "x", y = "Плотность вероятности")

p_value30 <- 2 * (1 - pnorm(abs(z_test_result30)))
p_value100 <- 2 * (1 - pnorm(abs(z_test_result100)))

```

## Ответ
1.  H0: px=py Доли людей с ССЗ в группах равны.
    Ha: px!=py Доли людей с ССЗ в группах не равны.

2.  Уровень значимости α: 0.05

3.  Статистический тест (критерий): Z-критерий для разности долей (асимптотический) для обоих исследований (по 30 и 100 человек в каждой группе), т.к. число неуспехов и успехо везде равно либо превышает 5. Тест двусторонний. 

Можно и так, но желательно в этом случае использовать тесты на ассоциацию - ОТВЕТ добавила ниже тест на ассоциацию

# Тест на ассоциацию
H0: физическая активность и ССЗ не ассоциированы.
Ha: физическая активность и ССЗ ассоциированы.
alpha = 0.05
Критерий Хи-квадрат, односторонний.
```{r}
# Загрузка необходимых библиотек
library(ggplot2)

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 30, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили
quantiles <- c(0.0, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df)
critical_value_upper <- qchisq(quantiles[2], df)

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared30 <- 0.1339  # Замените на ваше реальное наблюдаемое значение
observed_chi_squared100 <- 0.6464
# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared30,observed_chi_squared100),
             linetype = c("solid", "solid", "dashed", "dashed"),
             color = c("blue", "blue", "red", "green"),
             size = c(2, 2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.1, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 1, angle = 90) +
  annotate("text", x = critical_value_upper - 0.1, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 1, angle = 90) +
  annotate("text", x = observed_chi_squared30 - 0.1, y = 2.5, label = 'наблюдаемое30', hjust = 1, angle = 90) +
    annotate("text", x = observed_chi_squared100 - 0.1, y = 2.5, label = 'наблюдаемое100', hjust = 1, angle = 90) +
  annotate("text", x = critical_value_upper - 2, y = 2.5, label = sprintf("df = %.0f", df), hjust = 1)+
  xlim(NA,6)


```



```{r}
chi_result30 <- chisq.test(table(activity30, cardio30))
chi_result100 <- chisq.test(table(activity100, cardio100))

chi_result30$p.value
chi_result100$p.value

```

В тесте на ассоциацию также нулевые гипотезы не могут быть отвергнуты для обоих размеров выборок (р> 0.05).






```{r}

print(paste("4.  Критические значения статистики: ", round(quantile_values[1],2)," - ", round(quantile_values[2],2)))
      
print(paste("5.1  Наблюдаемое значение статистики для выборки в 100:", round(z_test_result100,2)))
print(paste("5.2  Наблюдаемое значение статистики для выборки в 30:", round(z_test_result30,2)))
print(paste("6.1  p-value для выборки в 100:", round(p_value100,3)))
print(paste("6.2  p-value для выборки в 30:", round(p_value30,3)))

# Коммент 5. Предлагаю пересмотреть результаты (данные изменятся) - ОТВЕТ пересчитала со скорректированным объемом выборки и заданием успехов в группах. Цифры изменились, но общие выводы нет.

```
6. Статистическая значимость: для обоих размеров выборки нулевую гипотезу не отвергаем.
7.  Практическая значимость: выборки таких размеров не выявили статистически значимых различий в частотах возникновения ССЗ у лиц старше 50 лет имеющих высокую либо низкую физическую активность. 

 # Коммент 6. Не совсем так, тест Фишера тестирует другую гипотезу. Как вариант можно поработать с точными доверительными интервалами (можно почитать по ссылке https://cran.r-project.org/web/packages/ExactCIdiff/index.html)
ОТВЕТ - ДЛЯ МАЛЫХ ВЫБОРОК МОЖНО БЫЛО БЫ ИСПОЛЬЗОВАТЬ Хи-квадрат с симуляцией Монте-Карло.



# Гипотеза 2.
**Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80

#Допустим стандартное отклонение артериального давления в генеральной совокупности
sd_gen = 10


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, 130, sd_gen)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, 135, 1.2*sd_gen)  # контрольная группа

```

## Решение


```{r}
alpha=0.05
t_test <- t.test(group1, group2, var.equal = FALSE, alternative="less", conf.level=1-alpha)

# Квантили
quantiles <- c(0.05, 1)

df=158

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# Коммент 7. Предлагаю пересмотреть результаты принимая во внимание 9 комментарий
# ОТВЕТ  - Альтернативный вариант теста - Критерий Манна-Уитни-Уилкоксона для независимых выборок

w_test <- wilcox.test(group1, group2, alternative = "less", paired = FALSE, conf.level = 1- alpha, conf.int = TRUE, exact=FALSE)

# Квантили
quantiles <- c(0.05, 1)

w_critical_low <- qwilcox(quantiles[1], sample_size, sample_size)
w_critical_up <-  qwilcox(quantiles[2], sample_size, sample_size)

```

## Ответ
1.  H0: mu1=mu2 средний уровень артериального давления в группах не отличается.
    Ha: mu1<mu2 средний уровень артериального давления в группе1 меньше, чем в группе 2(контроле).

2.  Уровень значимости α: 0.05

3.  Статистический тест (критерий): t-критерий (метод Уэлча) для разницы средних для независимых выборок, т.к. считаем, что дисперсии в двух группах неизвестны и неравны. Тест левосторонний (left-tail test). 

 #Коммент 8 "т.к. у нас общая популяция, то считаем, что дисперсии в двух группах неизвестны, но равны" - мы как раз тестируем если респонденты разных групп принадлежат или нет одной популяции. Поэтому опция дисперсии в двух группах неизвестны, но равны не очень корректна. Кроме этого, у нас выборки размером 80. Может попробовать другую опцию? 

ОТВЕТ- сравнила два теста на t-критерий с методом Уэлча и критерий Манна-Уитни-Уилкоксона для независимых выборок


```{r}
print("РЕЗУЛЬТАТ Т-КРИТЕРИЯ С МЕТОДОМ Уэлча")
print(paste("4. Критическое значение статистики: ", round(t_critical_low,2)))
print(paste("5. Наблюдаемое значение статистики:", round(t_test$statistic,2)))
print(paste("6. p-value:", format(t_test$p.value, scientific=T, digits=3)))
print(paste("ДИ:", round(t_test$conf.int[1],3), round(t_test$conf.int[2],3)))

print("РЕЗУЛЬТАТ КРИТЕРИЯ Манна-Уитни-Уилкоксона")
print(paste("4. Критическое значение статистики: ", round(w_critical_low,2)))
print(paste("5. Наблюдаемое значение статистики:", round(w_test$statistic,2)))
print(paste("6. p-value:", format(w_test$p.value, scientific=T, digits=3)))
print(paste("ДИ:", round(w_test$conf.int[1],3), round(w_test$conf.int[2],3)))

```
6. Статистическая значимость: нулевую гипотезу не отвергаем (критерий М-У-У).
7. Практическая значимость: среднее значение АД в экcпериментальной группе стастистически значимо не отличается от контрольной (p>0.05). # Коммент 9. И всё-таки попробуйте - ОТВЕТ Критерий Манна-Уитни-Уилкоксона не выявил стастически значимыз различий в средних.


# Гипотеза 3.
**Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, 100, 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, 100, 0.6)  

```

## Решение

```{r, fig.height =5, fig.width=5}
alpha <- 0.05
w_test <- wilcox.test(before, after, alternative = "less", paired = TRUE, conf.level = 1- alpha, conf.int = TRUE, exact=FALSE)

?wilcox.test

# Квантили
quantiles <- c(0.05, 1)

w_critical_low <- qwilcox(quantiles[1], sample_size, sample_size)
w_critical_up <-  qwilcox(quantiles[2], sample_size, sample_size)

```

## Ответ
1.  H0: mu1=mu2 средний уровень физической активности у пациентов не изменился после реабилитации.
    Ha: mu1<mu2 средний уровень физической активности у пациентов повышается после реабилитации.

2.  Уровень значимости α: 0.05.

3.  Статистический тест (критерий): Выборки связанные и маленькие (30), поэтому будем применять непараметрический (ранговый) критерий Тест Манна-Уитни-Уилкоксона ддя связанных выборок, левосторонний.



```{r}

print(paste("4. Критическое значение статистики: ", round(w_critical_low,2), "-", round(w_critical_up,2)))
      
print(paste("5. Наблюдаемое значение статистики:", round(w_test$statistic,2)))

print(paste("6. p-value:", format(w_test$p.value, scientific=T, digits=3)))
print(paste("ДИ:", round(w_test$conf.int[1],3), round(w_test$conf.int[2],3)))



```
6. Статистическая значимость: нулевую гипотезу отвергаем.
7. Практическая значимость: физическая активности повышается статистически значимо (медианное изменение 11, 95% односторониий ДИ: 8.5, Inf)) после реабилитации.

# Гипотеза 4.
**Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- c(rep(1, sample_size/2), rep(0, sample_size/2))

# Генерация данных по физической активности после лечения (бинарная переменная)
#activity <- c(rbinom(sample_size, 1, 0.7), rbinom(sample_size, 1, 0.65))
activity <- c(rep(1, 0.7*sample_size/2), rep(0, 0.3*sample_size/2), rep(0, 0.35*sample_size/2), rep(1, 0.65*sample_size/2))

table(treatment, activity)

# Коммент 10. Поработайте с генерацией данных. По условию всего 200 наблюдений, у вас всего 400. Кроме этого не соблюдены заложенные пропорции ОТВЕТ- переработала генерацию данных
    
```

## Решение

```{r, fig.height =5, fig.width=5}
# Функция для проведения z-теста для двух независимых долей
performTwoProportionZTest <- function(t) {
  
  x <- t[1,2]
  n1<- t[1,2]+t[1,1]
  
    y <- t[2,2]
  n2<- t[2,2]+t[2,1]
  
  # Расчет долей успешных исходов в выборках
  p1 <- x / n1
  p2 <- y / n2

  # Расчет объединенной доли успешных исходов
  P <- (x + y) / (n1 + n2)

  # Расчет стандартной ошибки
  SQ <- P * (1 - P) * (1/n1 + 1/n2)

  # Выполнение z-теста
  z_test_result <- (p1 - p2) / sqrt(SQ)

  return(z_test_result)
}

z_test_result <- performTwoProportionZTest(table(treatment, activity))
# Создание последовательности значений x
x_values <- seq(-4, 4, by = 0.01)

# Расчет значений Плотности Вероятности (PDF) для стандартного нормального распределения
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)

# Квантили
quantiles <- c(0.0, 0.95)

quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

# Создание данных для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = quantile_values, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = z_test_result, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = quantile_values[1]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], quantile_values[1]), hjust = 0, angle = 90) +
  annotate("text", x = quantile_values[2]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], quantile_values[2]), hjust = 0, angle = 90) +
  annotate("text", x = z_test_result-0.15, y = 0.2, label = 'observed, 100', hjust = 0, angle = 90)+
  labs(title = "PDF стандартного нормального распределения", x = "x", y = "Плотность вероятности")

p_value <- 2 * (1 - pnorm(abs(z_test_result)))

```

## Ответ
1.  H0: px=py доля пациентов, вернувшихся к нормальной физической активности после экспериментального лечения, не изменилась по сравнению со стандартом.
    Ha: px>py доля пациентов, вернувшихся к нормальной физической активности после экспериментального, выше, чем после стандартного лечения. # Коммент 11. Может всё-таки односторонняя гипотеза? ОТВЕТ-скорректировала решение на односторонний тест


2.  Уровень значимости α: 0.05.

3.  Статистический тест (критерий): Z-критерий для разности долей для независимых выборок (асимтотический). Выбран асимптотический тест, потому что кол-во успеха и неуспеха превышает 5 в обеих группах. Тест правосторонний (right-tailed).



```{r}

print(paste("4.  Критические значения статистики: ", round(quantile_values[1],2)," - ", round(quantile_values[2],2)))
print(paste("5.  Наблюдаемое значение статистики:", round(z_test_result,2)))
print(paste("6.  p-value:", format(p_value, scientific=T, digits=3)))

# Коммент 12. Предлагаю пересчитать и при сформулировать новые выводы
#ОТВЕТ-Пересчитала, но нулевую гипотезу не отвергаем

```
6. Статистическая значимость: нулевую гипотезу не отвергаем.
7. Практическая значимость: физическая активность среди пациентов с инфарктом миокарда не повышается статистически значимо после нового метода реабилитации по сравнению со стандартным методом (p> 0.05).


# Гипотеза 5. 
**Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- c(rbinom(sample_size, 1, 0.4))

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- c(rbinom(sample_size, 1, 0.2))

#table(after, before)

my_matrix <- matrix(c(sum(before == 1 & after == 1),
                      sum(before == 0 & after == 1 ), 
                      sum(before == 1 & after == 0),
                      sum(before == 0 & after == 0)), 
             nrow = 2, ncol = 2, 
             dimnames = list("До" = c("Стресс +", "Стресс -"), 
                             "После" = c("Стресс +", "Стресс -")))

print(my_matrix)

# Коммент 13. Поработайте с генерацией данных. По условию всего 50 наблюдений, у вас всего 100. Кроме этого не учтены пропорции и особенности составления таблиц для повторных измерений -
# ОТВЕТ - исправлено, при генерации считаем, что вероятность наличия стресса после медитации независит от наличия стресса до медитации

```

## Решение

```{r}
# Значение нулевой гипотезы
#p0 <- 0.5


# Рассчет стандартного отклонения
#stdev <- sqrt(p0*(1-p0))

# Выполнение z-теста
#z_test <- BSDA::z.test(after, mu = p0, alternative = "two.sided", sigma.x = stdev)

#quantiles <- c(0.025, 0.975)

#quantile_values <- qnorm(quantiles, mean = 0, sd = 1)


# Загрузка необходимых библиотек
library(ggplot2)

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 30, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили
quantiles <- c(0.0, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df)
critical_value_upper <- qchisq(quantiles[2], df)

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- (my_matrix[1,2] - my_matrix[2,1])*(my_matrix[1,2] - my_matrix[2,1])/(my_matrix[1,2] + my_matrix[2,1])

# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 1, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 1, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 1, angle = 90) +
  annotate("text", x = observed_chi_squared - 1, y = 2.5, label = 'наблюдаемое', hjust = 1, angle = 90) +
   
  annotate("text", x = critical_value_upper + 5, y = 2.5, label = sprintf("df = %.0f", df), hjust = 1)+
  xlim(NA,30)




mcn_test <- mcnemar.test(my_matrix, correct = FALSE)

```

## Ответ
1.  H0: p1=р2 Доля людей со стрессом до 8 недель медитации равна доли людей со стрессом после 8 недель медитации.
    Ha: p1 != p2 Доля людей со стрессом после 8 недель медитации не равна доли людей со стрессом до 8 недель медитации.
    
Гипотезы составлены на основе дизайна исследования. Исследование рандомизированное, набираются две группы по 50 человек с высоким уровнем тревожности, одна группа с наличием стресса, вторая группа без стресса. # Коммент 13. Речь идёт о повторных измерениях, соответственно рекомендация использовать McNemar test ОТВЕТ - исправила

2.  Уровень значимости α: 0.05.

3.  Статистический тест (критерий): тест мак-немара для повторных измерений. Односторонний тест.



```{r}

print(paste("4.  Критические значения статистики: ", round(critical_value_lower,2)," - ", round(critical_value_upper,2)))
print(paste("5.  Наблюдаемое значение статистики:", round(mcn_test$statistic,2)))
print(paste("6.  p-value:", format(mcn_test$p.value, scientific=T,digits=3)))


```
6. Статистическая значимость: нулевую гипотезу отвергаем.
7. Практическая значимость: Доля лиц со стрессом статистически значимо ниже после 8-ми недельной медитации (доля = 0.1), чем до медитации (доля = 0.56) (p<0.05) #  Коммент 14. Не очень понятна интерпретация - ОТВЕТ скорректировала

# Гипотеза 6. 
**Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).**

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rbinom(sample_size, 100, 0.55)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rbinom(sample_size, 100, 0.68)  # контрольная группа

mean(group1) - mean(group2)

```

## Решение

```{r}
alpha <- 0.05
w_test <- wilcox.test(group1, group2, alternative = "two.sided", paired = FALSE, conf.level = 1- alpha, conf.int = TRUE, exact=FALSE)

# Квантили
quantiles <- c(0.025, 0.975)

w_critical_low <- qwilcox(quantiles[1], sample_size, sample_size)
w_critical_up <-  qwilcox(quantiles[2], sample_size, sample_size)

```

## Ответ
1.  H0: mu1=mu2 средний уровень депрессии в группах не отличается.
    Ha: mu1!=mu2 средний уровень депрессии в группе1 не равен среднему уровню депрессии в группе2.

2.  Уровень значимости α: 0.05

3.  Статистический тест (критерий): т.к. мы не имеем информации о форме распределения, кроме независимости и равенстве распределений, и выборка небольшая (20) выберем критерий Манна-Уитни-Уилкоксона для независимых выборок. Двусторонний тест.



```{r}

print(paste("4. Критическое значение статистики: ", round(w_critical_low,2), "-", round(w_critical_up,2)))
      
print(paste("5. Наблюдаемое значение статистики:", round(w_test$statistic,2)))

print(paste("6. p-value:", format(w_test$p.value, scientific=T, digits=3)))
print(paste("ДИ:", round(w_test$conf.int[1],3), round(w_test$conf.int[2],3)))

```
6. Статистическая значимость: нулевую гипотезу отвергаем.
7. Практическая значимость: средний уровень депрессии статистически значимо ниже на 13 (95% ДИ: 10-16) в группе, получавшей экспериментальное лечение, по сравнению с группой, получавшей стандартное лечение.


# Гипотеза 7. 
**Длительность сна (в часах) ассоциирована с уровнем стресса у студентов (шкала с нормальным распределением)**

## Генерация данных

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```

## Решение (дополните решение визуализацией)

```{r, fig.height =3, fig.width=3}
library(ggplot2)
c_test <- cor.test(df$HoursOfSleep, df$StressLevel,
         alternative = c("two.sided"),
         method = c("pearson"),
         exact = NULL, conf.level = 0.95)

# Квантили
quantiles <- c(0.025, 0.975)

dff=sample_size-2

t_critical_low <- qt(quantiles[1], df = dff)
t_critical_up <-  qt(quantiles[2], df = dff)


ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) + 
    geom_point(size = 1.1)  + 
    labs(x = "Длительность сна, ч", 
         y = "Уровень стресса") + 
    geom_text(x = 4.5, 
              y = 4,
              label = "r=-0.5,\np < 0.001",
              hjust = 0,
              vjust = 1) + 
    
    # Добавим линию регрессии
    
    geom_smooth(method = "lm") +
    
    # Поменяем оформление графика
    theme_bw()


```

## Ответ
1.  H0: r=0 Длительность сна (в часах) не ассоциирована с уровенем стресса у студентов.
    Ha: r!=0 Длительность сна (в часах) ассоциирована с уровенем стресса у студентов.

2.  Уровень значимости α: 0.05

3.  Статистический тест (критерий): В качестве критерия будем использовать корреляцию Пирсона. Двусторонний тест.


```{r}

print(paste("4.  Критическое значение статистики: ", round(t_critical_low,2), "-", round(t_critical_up,2)))
      
print(paste("5. Наблюдаемое значение статистики:", round(c_test$statistic,2)))

print(paste("6.  p-value:", format(c_test$p.value, scientific=T, digits=3)))
print(paste("ДИ:", round(c_test$conf.int[1],3), round(c_test$conf.int[2],3)))
```
6. Статистическая значимость: нулевую гипотезу отвергаем.
7. Практическая значимость: Длительность сна ассоциирована с уровнем стресса у студентов, коэффициент корреляции Пирсона = -0.52 (95%ДИ: [-0.65, -0.36]). #  Коммент 15. Значим ли эффект с практической точки зрения? ОТВЕТ - Т.к. коэффициент корреляции Пирсона отрицательный, это говорит о том, что у студентов с более низким уровнем стресса более продолжительна длительность сна. Однако, значение коффициента не приближено к нулю, возможно стоит потестировать другую форму зависимости, кроме линейной.


