---
title: "Sample_size_calc"
author: "Andreychenko Anna"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(TrialSize)
library(epiR)


```

# Задание 1.
## Текст задания
Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите. Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей эффективности – 2 %.

## Решение
Конечная точка - количественная конечная точка.
Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим образом:

H0: mT – mR ≤ δ

HA: mT – mR > δ

Где mT – среднее абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии препаратом Т, mR – среднее абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии препаратом R. δ – граница неменьшей эффективности (-2%).

При расчёте необходимого размера выборки были сделаны следующие допущения: <br />
1. Распределение в группы будет равномерным в соотношении 1:1;  <br /> 
2. Односторонняя величина ошибки I рода (α) составляет 0.025; <br />
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; <br />
4. На основании литературных данных мы ожидаем величину эффекта в группе исследуемого препарата T и контрольной группе (препарат R) ~ 7.2 (mT и mR). <br />
5. Граница неменьшей эффективности препарата T по сравнению с препаратом R равна -2%. <br />
Расчёт размера выборки был проведён в RStudio (2024.09.0 Build 375) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4). <br />
Результаты расчёта представлены далее.
```{r, echo = TRUE}

TwoSampleMean.NIS(
  alpha = 0.025, 
  beta = 0.2,
  sigma = 3.1,
  k = 1, 
  delta = -2,
  margin = 0
)

```
Таким образом, в каждую группу необходимо включить не менее 38 обследуемых, всего – 76
пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в каждую группу
необходимо набрать не менее 48 человек. В скрининг (с учётом 10% выбывания) необходимо
включить не менее 54 обследуемых в каждую группу.

```{r, results = 'hide'}

NT <- ceiling(TwoSampleMean.NIS(
  alpha = 0.025, 
  beta = 0.2,
  sigma = 3.1,
  k = 1, 
  delta = -2,
  margin = 0
))

NT1 <- ceiling(NT/0.8)
NT2 <- ceiling(ceiling(NT/0.8)/0.9)

epi.ssninfc(
  treat = 7.2,
  control= 7.2,
  sigma = 3.1,
  delta = 2,
  n = NA,
  power = 0.8,
  r = 1,
  alpha = 0.025
  
)
```


# Задание 2.
## Текст задания
Исследование превосходства препарата T над референтным лечением R в лечении рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

## Решение
Конечная точка - пропорция.
Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:

H0: PT – PR ≤ δ

HA: PT – PR > δ

Где PT – доля пациентов без новых очагов после терапии препаратом Т, PT – доля пациентов без новых очагов после терапии препаратом R. δ – граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие допущения: <br />
1. Распределение в группы будет неравномерным в соотношении 2:1;  <br /> 
2. Односторонняя величина ошибки I рода (α) составляет 0.025; <br />
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; <br />
4. На основании литературных данных мы ожидаем величину эффекта в группе препарата R ~ 66%, на основании ожиданий спонсора величина эффекта в группе препарата T ~ 66% + 15% = 81%; <br />
5. Граница превосходства препарата T по сравнению с препаратом R равна 1%. <br />
Расчёт размера выборки был проведён в RStudio (2024.09.0 Build 375) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4). <br />
Результаты расчёта представлены далее.
```{r, echo = TRUE}

TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.81,
  p2 = 0.66,
  k = 2,
  delta = 0.15,
  margin = 0.01
)

```
Таким образом, в тестовую группу необходимо включить не менее 242 пациентов, в контрольную групп не менее 121 пациента, всего – 363 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в тестовую группу необходимо набрать не менее 303 человека, а в контрольную не менее 152 человека. В скрининг (с учётом 10% выбывания) необходимо включить не менее 337 пациента в тестовую группу, и не менее 169 пациентов в контрольную.

```{r, results = 'hide'}

NT <- ceiling(TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.81,
  p2 = 0.66,
  k = 2,
  delta = 0.15,
  margin = 0.01
))

NT1 <- ceiling(NT/0.8)
NT2 <- ceiling(ceiling(NT/0.8)/0.9)

NC <- NT/2

NC1 <- ceiling(NC/0.8)
NC2 <- ceiling(ceiling(NC/0.8)/0.9)


epi.sssupb(
  treat = 0.81,
  control= 0.66,
  delta = 0.01,
  n = NA,
  power = 0.8,
  r = 2,
  alpha = 0.025
  
)
```
# Задание 3.
## Текст задания
Исследование превосходства нового препарата А над препаратом Б в профилактике интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из
данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём
кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается
установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы
препарат А получили 75% пациентов, включённых в исследование.

## Решение
Конечная точка - количественная конечная точка.
Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:

H0: mА – mБ ≤ δ

HA: mА – mБ > δ

Где mА – средний объём (мл) кровопотери при применении препарата А, mБ – средний объём (мл) кровопотери при применении препарата Б. δ – граница превосходства (-50 мл).

При расчёте необходимого размера выборки были сделаны следующие допущения: <br />
1. Распределение в группы будет неравномерным в соотношении 3:1;  <br /> 
2. Односторонняя величина ошибки I рода (α) составляет 0.025; <br />
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; <br />
4. На основании данных мы ожидаем величину эффекта в группе препарата Б ~ 306 мл (mR), а группе исследуемого препарата А на 20% ниже ~ 244.8 мл. <br />
5. Граница превосходства препарата А по сравнению с препаратом Б равна -50 мл. <br />
Расчёт размера выборки был проведён в RStudio (2024.09.0 Build 375) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4). <br />
Результаты расчёта представлены далее.
```{r, echo = TRUE}

TwoSampleMean.NIS(
  alpha = 0.025, 
  beta = 0.2,
  sigma = 52,
  k = 3, 
  delta = -50,
  margin = -61.2
)

```
Таким образом, в группу препарата А необходимо включить не менее 677 пациентов, в группу препарата Б не менее 226 пациента, всего – 903 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в группу препарата А необходимо набрать не менее 847 человека, а в группу препарата Б не менее 283 человека. В скрининг (с учётом 10% выбывания) необходимо включить не менее 942 пациента в группу препарата А, и не менее 315 пациентов в группу препарата Б.

```{r, results = 'hide'}

NT <- ceiling(TwoSampleMean.NIS(
  alpha = 0.025, 
  beta = 0.2,
  sigma = 52,
  k = 3, 
  delta = -50,
  margin = -61.2
))

NT1 <- ceiling(NT/0.8)
NT2 <- ceiling(ceiling(NT/0.8)/0.9)

NC <- ceiling(NT/3)

NC1 <- ceiling(NC/0.8)
NC2 <- ceiling(ceiling(NC/0.8)/0.9)

epi.sssupc(
  treat = 306,
  control= 244.8,
  sigma = 52,
  delta = 50,
  n = NA,
  power = 0.8,
  r = 3,
  alpha = 0.025
  
)
```

# Задание 4.
## Текст задания
Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%.
При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования.

## Решение
Конечная точка - пропорция.
Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:

H0: PY – PX ≤ δ

HA: PY – PX > δ

Где PY – доля пациентов с рецедивами после терапии препаратом Y, PX – доля пациентов с рецедивами после терапии препаратом X. δ – граница превосходства (-5%).

При расчёте необходимого размера выборки были сделаны следующие допущения: <br />
1. Распределение в группы будет неравномерным в соотношении 4:1, чтобы учесть ограничения спонсора по кол-ву препарата Х;  <br /> 
2. Односторонняя величина ошибки I рода (α) составляет 0.025; <br />
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; <br />
4. На основании литературных данных мы ожидаем величину эффекта в группе препарата X ~ 32%, на основании ожиданий спонсора величина эффекта в группе препарата Y ~ 32% - 15% = 17%; <br />
5. Граница превосходства препарата Y по сравнению с препаратом X равна -5%. <br />
Расчёт размера выборки был проведён в RStudio (2024.09.0 Build 375) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4). <br />
Результаты расчёта представлены далее.
```{r, echo = TRUE}

TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.17,
  p2 = 0.32,
  k = 4,
  delta = - 0.15,
  margin = - 0.05
)

```
Таким образом, в группу препарата Y необходимо включить не менее 794 пациентов, в группу препарата X не менее 199 пациента, всего – 993 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в группу препарата Y необходимо набрать не менее 993 человека, а в группу препарата X не менее 249 человека. В скрининг (с учётом 10% выбывания) необходимо включить не менее 1104 пациента в группу препарата Y, и не менее 277 пациентов в группу препарата X.

```{r, results = 'hide'}

NT <- ceiling(TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.17,
  p2 = 0.32,
  k = 4,
  delta = -0.15,
  margin = -0.05
))

NT1 <- ceiling(NT/0.8)
NT2 <- ceiling(ceiling(NT/0.8)/0.9)

NC <- NT/4

NC1 <- ceiling(NC/0.8)
NC2 <- ceiling(ceiling(NC/0.8)/0.9)


epi.sssupb(
  treat = 0.32,
  control= 0.17,
  delta = 0.05,
  n = NA,
  power = 0.8,
  r = 0.25,
  alpha = 0.025
  
)
```


