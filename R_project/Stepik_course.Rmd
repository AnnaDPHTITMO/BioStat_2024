---
title: "Stepik_course"
author: "Anna"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r 4.1}
library(readr)
data <- read_tsv("data_tsv.tsv", skip = 0, n_max = Inf)
```

```{r 4.1 write}
write_csv(data, "data_csv.csv")

write_excel_csv(data, "data_csv.csv")

write_csv2(data, "data_csv2.csv")

write_excel_csv2(data, "data_csv2.csv")
```

```{r 4.1 excel}
library(readxl)
dataexc <- read_excel("data_excel.xlsx", sheet = "data_csv2")
library(openxlsx)
write.xlsx(dataexc, "data_excel1.xlsx", colNames = TRUE)
```
## Раздел 5.1
```{r 5.1}
#quantile(c(32.05, 93.85, 85.52, 56.69, 23.69, 11.29, 51.44, 63.09, 65.65, 35.73, 60.15, 30.93, -4.2), probs=0.95)

t <- c(92.11, 56, 47.89, 62.96, 47.41, 37.05, 73.96, 53, 52.37, 85.23)

# c(var(t), sd(t))
# IQR(t)
sd(t)/sqrt(length(t))

```
## Раздел 5.2
```{r 5.2}

#summary(data)
library(psych)
library(readr)
#data <- read_rds("numeric_data.rds")
#psych::describe(data)

data <- read_rds("factor_data.rds")
table(data$Группа, data$"Группа крови")
prop.table(table(data$Группа, data$"Группа крови"))
```
## Раздел 6.1
```{r}
library(readr)
data <- read_tsv("data_tsv.tsv", skip = 0, n_max = Inf)
str(data)
```
```{r}
library(tibble)
# as_tibble(data)
# data %>% View()
library(dplyr)

# data %>%
  # add_column(just_column = "just_values",.before=1) %>%
  # add_row(`Группа` = "New_group", `Возраст` = 100, .before =1)

data %>%
  mutate(., ID = row_number())

```
# Раздел 6.2
```{r}
library(dplyr)
data_1 <- tibble(var_1 = 1:10, var_2 = rep(c("Группа 1", "Группа 2"), 5))
data_2 <- tibble(var_2 = rbeta(10,1,5), var_3 = rnorm(10))
data_3 <- tibble(var_4 = 100:91, var_5 = rep(c("Молодые", "Средний возраст"), 5))
data_1 %>% bind_cols(data_2) %>% bind_cols(data_3)
```
```{r}
data_1 <- tibble(var_1 = 1:8) %>% mutate(id = row_number())
data_2 <- tibble(var_2 = rnorm(10)) %>% mutate(`Subject ID` = row_number())
data_1 %>%
  left_join(data_2, by=c("id"="Subject ID"))
```
```{r}
data_1 %>%
  right_join(data_2, by=c("id"="Subject ID"))
```
```{r}
data_1 %>%
  inner_join(data_2, by=c("id"="Subject ID"))
```
```{r}
data_1 %>%
  full_join(data_2, by=c("id"="Subject ID"))
```
## Раздел 6.3
```{r}
data %>% group_by(`Группа`) %>% ungroup()
data %>% 
  split(~`Группа`)

```
```{r}
data %>% 
  rowwise() %>%
  mutate(`Среднее по базофилам за два визита` = mean(c(`Базофилы_E1`, `Базофилы_E2`))) %>%
  ungroup() %>%
  select(`Базофилы_E1`,`Базофилы_E2`,`Среднее по базофилам за два визита`)
  

```
# Раздел 6.4
```{r}
library(readr)
library(dplyr)
# data <- read_tsv("data_tsv.tsv", skip = 0, n_max = Inf)

# data %>%
#  select(`Группа крови`,`Рост`)

# data %>%
#  select(!`Группа`)

#data %>%
#  select(where(is.numeric))

#data %>%
#  select(`Группа`, function(x) is.numeric(x) & mean(x, na.rm = TRUE) > 10)

#data %>% select(contains("_E1"))

#data %>% select(matches("_E\\d{1}"))
data %>% select(starts_with("Б"))

data %>% select(ends_with("E2"))  

```
```{r}
variables <- c("Базофилы_E1", "Эозинофилы_E1", "Гемоглобин_E1")
data %>% select(any_of(variables))
```
```{r}

data %>% 
  select(where(is.numeric)) %>%
  select(function(x) sd(x, na.rm = TRUE) > 2 & mean(x, na.rm = TRUE) < 10)

data %>% 
  select(where(is.numeric)) %>%
  select(function(x) sd(x, na.rm = TRUE) > 2 | mean(x, na.rm = TRUE) < 10 | median(x, na.rm = TRUE > 5))

data %>% 
  select(!where(is.numeric))
```
```{r}
data %>% 
  select(`Пол`, `Эритроциты_E1`, everything())

data %>%
  select(`Эритроциты_Визит1` = `Эритроциты_E1`, `Эритроциты_Визит2` =`Эритроциты_E1`)
```
# Раздел 6.5
```{r}
#data %>% 
#  slice(1:10 * -1)

#data %>% 
#  slice_head(n=10)

data %>% 
  slice_head(prop = 0.05)

data %>% 
  slice_tail(prop = 0.05)

data %>% 
  slice_sample(prop = 0.05)

data %>% 
  slice_min(`Возраст`)

data %>% 
  slice_max(`Возраст`)

```
```{r}
data %>%
  filter(`Пол` == "Женский")

data %>%
  filter(`Группа крови` %in% c("A (II)", "O (I)") & `Группа` != "Группа 1")

data %>%
  filter(between(`Возраст`, 31, 34))

data %>%
  filter(near(Эозинофилы_E1, 3.38, tol = 0.1))

```
```{r}
data %>% 
  filter(if_all(.cols = contains ("Базофилы"), .fns = function(x) x > 1.5))

data %>% 
  filter(if_any(.cols = contains ("Базофилы"), .fns = function(x) x > 1.5))
data %>%
  group_by(`Группа`) %>%
  filter(`Возраст` > 36)
```
# Раздел 6.6
```{r}
data %>%
  mutate(`Женщины с четвертой гр крови` = ifelse (`Пол` == "Женский" & `Группа крови` == "AB (IV)", "Да", "Нет")) %>%
  select(`Женщины с четвертой гр крови`, everything()) %>%
  arrange(`Женщины с четвертой гр крови`)
```
```{r}
data %>%
  mutate(`Возрастная группа` = case_when(`Возраст` < 20 ~ "< 20",
                                         between(`Возраст`, 20,30) ~ "20 - 30",
                                         `Возраст` > 30 ~ "> 30") %>% as.factor()) %>%
  select(`Возраст`,`Возрастная группа`)

library(tidyr)

data %>%
  mutate(`Группа крови` = `Группа крови` %>% as.character() %>% replace_na("Нет данных") %>% as.factor())
  
data %>%
  mutate(`Группа крови` = `Группа крови` %>% na_if("B (III)"))         
```
```{r}
data %>%
  mutate(`Группа` = NULL)
```
```{r}
#data %>%
#  mutate(across(where(is.numeric), function(x) (x - mean(x, na.rm = TRUE))/ sd(x, na.rm = TRUE)))

#data %>%
#  mutate(across(contains("E1"), function(x) (x - mean(x, na.rm = TRUE))/ sd(x, na.rm = TRUE)))

#data %>%
#  mutate(across(where(function(x) is.numeric(x) & mean(x, na.rm = TRUE) < 10), function(x) (x - mean(x, na.rm = TRUE))/ #sd(x, na.rm = TRUE)))

data %>% mutate(across(!contains("E1") & !c(`Группа`, `Возраст`) & !where(is.factor) & !where(is.character), function(x) x ^ 2), across(contains("E2"), function(x) x * 100))

```
```{r}
data %>%
  rowwise() %>%
  mutate(`Среднее по базофилам` = mean(c_across(contains("Базофилы")))) %>%
  ungroup() %>%
  select(contains("Базофил"))

data %>%
  group_by(`Группа`) %>%
  mutate(across(contains("Базофилы"), function(x) x - mean(x, na.rm = TRUE))) %>%
  ungroup() %>%
  select(`Группа`, contains("Базофилы"))

```
# Раздел 6.7











## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
